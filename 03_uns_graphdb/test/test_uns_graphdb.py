"""*******************************************************************************
* Copyright (c) 2021 Ashwin Krishnan
*
* All rights reserved. This program and the accompanying materials
* are made available under the terms of MIT and  is provided "as is",
* without warranty of any kind, express or implied, including but
* not limited to the warranties of merchantability, fitness for a
* particular purpose and noninfringement. In no event shall the
* authors, contributors or copyright holders be liable for any claim,
* damages or other liability, whether in an action of contract,
* tort or otherwise, arising from, out of or in connection with the software
* or the use or other dealings in the software.
*
* Contributors:
*    -
*******************************************************************************

Tests for Uns_MQTT_GraphDb
"""

import json
import sys
from pathlib import Path

import pytest
from neo4j import exceptions
from paho.mqtt.packettypes import PacketTypes
from paho.mqtt.properties import Properties
from uns_mqtt.mqtt_listener import MQTTVersion
from uns_sparkplugb.uns_spb_helper import convert_spb_bytes_payload_to_dict

from uns_graphdb.graphdb_config import GraphDBConfig
from uns_graphdb.uns_mqtt_graphdb import UnsMqttGraphDb

test_folder = (Path(__file__).resolve().parent.parent / "test").resolve()
sys.path.insert(0, str(test_folder))
# @FIXME Hack done to be able to import utility modules in the tests directories
# @See https://docs.pytest.org/en/7.1.x/explanation/pythonpath.html importlib
import test_graphdb_handler  # noqa: E402


@pytest.mark.integrationtest()
def test_uns_mqtt_graph_db():
    """
    Test the constructor of the class Uns_MQTT_GraphDb
    """
    uns_mqtt_graphdb = None
    try:
        uns_mqtt_graphdb = UnsMqttGraphDb()
        uns_mqtt_graphdb.uns_client.loop()
        assert uns_mqtt_graphdb is not None, "Connection to either the MQTT Broker or the Graph DB did not happen"
    except Exception as ex:
        pytest.fail(
            f"Connection to either the MQTT Broker or the Graph DB did not happen: Exception {ex}",
        )
    finally:
        if uns_mqtt_graphdb is not None:
            uns_mqtt_graphdb.uns_client.disconnect()

        if (uns_mqtt_graphdb is not None) and (uns_mqtt_graphdb.graph_db_handler is not None):
            uns_mqtt_graphdb.graph_db_handler.close()


# spell-checker:disable
@pytest.mark.integrationtest()
@pytest.mark.parametrize(
    "topic, message",  # Test spB message persistence
    [
        # Test UNS message persistence
        (
            "test/uns/ar1/ln2",
            {
                "timestamp": 1486144502122,
                "TestMetric2": "TestUNS",
            },
        ),
        (
            "test/uns/ar2/ln3",
            {
                "timestamp": 1486144502144,
                "TestMetric2": "TestUNSwithLists",
                "list": [1, 2, 3, 4, 5],
            },
        ),
        (
            "test/uns/ar2/ln4",
            {
                "timestamp": 1486144500000,
                "TestMetric2": "TestUNSwithNestedLists",
                "dict_list": [
                    {
                        "a": "b",
                    },
                    {
                        "x": "y",
                    },
                ],
            },
        ),
        # ("test/uns/ar2/ln4", { # currently failing. validate if such a structure needs to be supported
        #     "timestamp": 1486144500000,
        #     "TestMetric2": "TestUNSwithNestedLists",
        #     "dict_list": [{"a": "b"}, {"x": "y"}, ],
        #     "nested_dict": [[1, 2, 3], ["q", "w", "r"], ["a", "b", "d"]]
        # }),
        (
            "spBv1.0/uns_group/NBIRTH/eon1",
            b"\x08\xc4\x89\x89\x83\xd30\x12\x17\n\x08Inputs/A\x10\x00\x18\xea\xf2\xf5\xa8\xa0+ "
            b"\x0bp\x00\x12\x17\n\x08Inputs/B\x10\x01\x18\xea\xf2\xf5\xa8\xa0+ \x0bp\x00\x12\x18\n\t"
            b"Outputs/E\x10\x02\x18\xea\xf2\xf5\xa8\xa0+ \x0bp\x00\x12\x18\n\tOutputs/F\x10\x03\x18\xea\xf2\xf5\xa8\xa0+ "
            b"\x0bp\x00\x12+\n\x18Properties/Hardware Make\x10\x04\x18\xea\xf2\xf5\xa8\xa0+ \x0cz\x04Sony\x12!\n\x11"
            b"Properties/Weight\x10\x05\x18\xea\xf2\xf5\xa8\xa0+ \x03P\xc8\x01\x18\x00",
        ),
        (
            "spBv1.0/uns_group/NDATA/eon1",
            b"\x08\xc4\x89\x89\x83\xd30\x12\x17\n\x08Inputs/A\x10\x00\x18\xea\xf2\xf5\xa8\xa0+ "
            b"\x0bp\x00\x12\x17\n\x08Inputs/B\x10\x01\x18\xea\xf2\xf5\xa8\xa0+ \x0bp\x00\x12\x18\n\t"
            b"Outputs/E\x10\x02\x18\xea\xf2\xf5\xa8\xa0+ \x0bp\x00\x12\x18\n\tOutputs/F\x10\x03\x18\xea\xf2\xf5\xa8\xa0+ "
            b"\x0bp\x00\x12+\n\x18Properties/Hardware Make\x10\x04\x18\xea\xf2\xf5\xa8\xa0+ \x0cz\x04Sony\x12!\n\x11"
            b"Properties/Weight\x10\x05\x18\xea\xf2\xf5\xa8\xa0+ \x03P\xc8\x01\x18\x00",
        ),
        (
            "spBv1.0/uns_group/DDATA/device_1",
            b"\x08\x88\xa9\x85\xe5\xd11\x12\xef\x01\n\x0bInputs/int8\x18\xea\xf2\xf5\xa8\xa0+ \x01J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`P\n\x12\xf4\x01\n\x0fInputs/int8.Neg\x18\xeb\xf2\xf5\xa8\xa0+ \x01J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`P\xf6\x01\x12\xf0\x01\n\x0cInputs/uint8\x18\xeb\xf2\xf5\xa8\xa0+ \x05J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`P\n\x12\xf6\x01\n\x10Inputs/int16.neg\x18\xeb\xf2\xf5\xa8\xa0+ \x02J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`P\x9c\xff\x03\x12\xf1\x01\n\rInputs/uint16\x18\xeb\xf2\xf5\xa8\xa0+ \x06J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`Pd\x12\xf5\x01\n\x10Properties/int32\x18\xea\xf2\xf5\xa8\xa0+ \x03J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`P\xc8\x01\x12\xfc\x01\n\x14Properties/int32.neg\x18\xea\xf2\xf5\xa8\xa0+ \x03J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`P\xb8\xfe\xff\xff\x0f\x12\xf6\x01\n\x11Properties/Uint32\x18\xea\xf2\xf5\xa8\xa0+ \x07J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`P\xc8\x01\x12\xf9\x01\n\x10Outputs/DateTime\x18\xea\xf2\xf5\xa8\xa0+ \rJ\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`X\xea\xf2\xf5\xa8\xa0+\x12\xf4\x01\n\x0eOutputs/Uint64\x18\xea\xf2\xf5\xa8\xa0+ \x08J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`X\xc0\xc4\x07\x12\xfe\x01\n\x11Outputs/int64.Neg\x18\xea\xf2\xf5\xa8\xa0+ \x04J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`X\xc0\xbb\xf8\xff\xff\xff\xff\xff\xff\x01\x12\xf0\x01\n\x0cOutputs/Bool\x18\xea\xf2\xf5\xa8\xa0+ \x0bJ\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`p\x00\x12\xf4\x01\n\rOutputs/Float\x18\xea\xf2\xf5\xa8\xa0+ \tJ\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`e\x92\xcb\x8f?\x12\xf9\x01\n\x0eOutputs/Double\x18\xea\xf2\xf5\xa8\xa0+ \nJ\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`iEGr\xf9Q\xde\xfd@\x12\xf9\x01\n\x11Properties/String\x18\xea\xf2\xf5\xa8\xa0+ \x0cJ\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`z\x04Sony\x12\x90\x02\n\x0fProperties/Text\x18\xea\xf2\xf5\xa8\xa0+ \x0eJ\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`z\x1dSony made this device in 1986\x12\xf9\x01\n\x11Inputs/int8.Array\x18\xea\xf2\xf5\xa8\xa0+ \x16J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01\x03\n\x0b\xe9\x12\xfb\x01\n\x12Inputs/int16.Array\x18\xea\xf2\xf5\xa8\xa0+ \x17J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01\x04\xd0\x8a0u\x12\xff\x01\n\x12Inputs/int32.Array\x18\xea\xf2\xf5\xa8\xa0+ \x18J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01\x08\xff\xff\xff\xff\xfa\xaf\xcb\x12\x12\x87\x02\n\x12Inputs/int64.Array\x18\xea\xf2\xf5\xa8\xa0+ \x19J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01\x10\xce\x06r\xac\x18\x9c\xba\xc4\xc4\xba\x9c\x18\xacr\x06\xce\x12\xf9\x01\n\x12Inputs/uint8.Array\x18\xea\xf2\xf5\xa8\xa0+ \x1aJ\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01\x02\x17\xfa\x12\xfc\x01\n\x13Inputs/uint16.Array\x18\xea\xf2\xf5\xa8\xa0+ \x1bJ\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01\x04\x1e\x00\x88\xcc\x12\x80\x02\n\x13Inputs/uint32.Array\x18\xea\xf2\xf5\xa8\xa0+ \x1cJ\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01\x084\x00\x00\x00I\xfbU\xc4\x12\x88\x02\n\x13Inputs/uint64.Array\x18\xea\xf2\xf5\xa8\xa0+ \x1dJ\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01\x10}\x14\x00\x00\x00\x00\x00\x00\xd9\x9e\x02\xd1\xb2v7\xe4\x12\x8a\x02\n\x15Inputs/datetime.Array\x18\xea\xf2\xf5\xa8\xa0+ \x1dJ\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01\x10jy\x1d\x05Z\x01\x00\x00\"\x85\x1d\x05Z\x01\x00\x00\x12\xfe\x01\n\x14Inputs/boolean.Array\x18\xea\xf2\xf5\xa8\xa0+  J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01\x05\x03\x00\x00\x00\xa0\x12\xb6\x02\n\x13Inputs/string.Array\x18\xea\xf2\xf5\xa8\xa0+ !J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01>4920616d206120737472696e67\x004920746f6f20616d206120737472696e67\x00\x12\x82\x02\n\x0bInputs/UUID\x18\xea\xf2\xf5\xa8\xa0+ \x0fJ\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`z\x13unique_id_123456789\x12\xf7\x01\n\x0cInputs/bytes\x18\xea\xf2\xf5\xa8\xa0+ \x11J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01\x06\x0c\x00\x00\x004\xd0\x12\x80\x02\n\x0bInputs/file\x18\xea\xf2\xf5\xa8\xa0+ \x12J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x82\x01\x10\xc7\xd0\x90u$\x01\x00\x00\xb8\xba\xb8\x97\x81\x01\x00\x00\x12\xb8\x03\n\x0eInputs/dataset\x18\xea\xf2\xf5\xa8\xa0+ \x10J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x8a\x01\xc4\x01\x08\x05\x12\x06uint32\x12\x06double\x12\x05int64\x12\x06string\x12\x07boolean\x18\x07\x18\n\x18\x08\x18\x0c\x18\x0b\".\n\x02\x08\n\n\t!\x00\x00\x00\x00\x00\x00Y@\n\x04\x10\xa0\x8d\x06\n\x132\x11I am dataset row1\n\x02(\x00\".\n\x02\x08\x14\n\t!\x00\x00\x00\x00\x00\x00i@\n\x04\x10\xc0\x9a\x0c\n\x132\x11I am dataset row2\n\x02(\x01\".\n\x02\x08\x1e\n\t!\x00\x00\x00\x00\x00\xc0r@\n\x04\x10\xe0\xa7\x12\n\x132\x11I am dataset row3\n\x02(\x00\x12\xb4\x02\n\x0fInputs/template\x18\xea\xf2\xf5\xa8\xa0+ \x13J\xd4\x01\n\x04key1\n\x04key2\n\x04key3\n\x04key4\n\x04key5\n\x04key6\n\x04key7\x12\x04\x08\x07\x18\n\x12\x05\x08\x08 \x90N\x12\x07\x08\t-r\xf9!A\x12\x0b\x08\n1\t\xd1\xad\xf9\x01j\xf8@\x12\x0c\x08\x0cB\x08String 1\x12'\x08\x14J#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x12N\x08\x15RJ\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\n#\n\x06key1_1\n\x06key1_2\x12\n\x08\x0cB\x06nested\x12\x05\x08\x07\x18\xb9`\x92\x01@\n\x07v_0.1.1\x12\n\n\x04met1 \x0bp\x01\x1a\x0b\n\x05prop1\x10\x07\x18d\x1a\x1a\n\x05prop2\x10\x0cB\x0fproperty string(\x01\x18\x00",  # noqa: E501
        ),
    ],
)
# spell-checker:enable
def test_mqtt_graphdb_persistence(topic: str, message: dict):
    """
    Test the persistence of message (UNS & SpB) to the database
    """
    uns_mqtt_graphdb = None
    try:
        uns_mqtt_graphdb = UnsMqttGraphDb()
        uns_mqtt_graphdb.uns_client.loop()

        def on_message_decorator(client, userdata, msg):
            old_on_message(client, userdata, msg)
            if topic.startswith("spBv1.0/"):
                message_dict: dict = convert_spb_bytes_payload_to_dict(message)
                node_type = GraphDBConfig.spb_node_types
            else:
                message_dict = message
                node_type = GraphDBConfig.uns_node_types

            attr_nd_typ: str = GraphDBConfig.nested_attributes_node_type

            try:
                with uns_mqtt_graphdb.graph_db_handler.connect().session(
                    database=uns_mqtt_graphdb.graph_db_handler.database,
                ) as session:
                    session.execute_read(test_graphdb_handler.read_topic_nodes, node_type, attr_nd_typ, topic, message_dict)
            except (exceptions.TransientError, exceptions.TransactionError) as ex:
                pytest.fail("Connection to either the MQTT Broker or " f"the Graph DB did not happen: Exception {ex}")
            finally:
                # After successfully validating the data run a new transaction to delete
                with uns_mqtt_graphdb.graph_db_handler.connect().session(
                    database=uns_mqtt_graphdb.graph_db_handler.database,
                ) as session:
                    session.execute_write(test_graphdb_handler.cleanup_test_data, topic.split("/")[0], node_type[0])
                uns_mqtt_graphdb.uns_client.disconnect()

        # --- end of function

        publish_properties = None
        if uns_mqtt_graphdb.uns_client.protocol == MQTTVersion.MQTTv5:
            publish_properties = Properties(PacketTypes.PUBLISH)

        if topic.startswith("spBv1.0/"):
            payload = message
        else:
            payload = json.dumps(message)

        # Overriding on_message is more reliable that on_publish because some times
        # on_publish was called before on_message
        old_on_message = uns_mqtt_graphdb.uns_client.on_message
        uns_mqtt_graphdb.uns_client.on_message = on_message_decorator

        # publish the messages as non-persistent to allow the tests to be
        # idempotent across multiple runs
        uns_mqtt_graphdb.uns_client.publish(
            topic=topic, payload=payload, qos=uns_mqtt_graphdb.uns_client.qos, retain=False, properties=publish_properties
        )

        uns_mqtt_graphdb.uns_client.loop_forever()
    except Exception as ex:
        pytest.fail(
            f"Connection to either the MQTT Broker or the Graph DB did not happen: Exception {ex}",
        )

    finally:
        if uns_mqtt_graphdb is not None:
            uns_mqtt_graphdb.uns_client.disconnect()

        if (uns_mqtt_graphdb is not None) and (uns_mqtt_graphdb.graph_db_handler is not None):
            uns_mqtt_graphdb.graph_db_handler.close()
